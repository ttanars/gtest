<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>เช็คอินครู - โรงเรียนปากช่อง สพม. นครราชสีมา</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Signature Pad -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
  
  <style>
    body {
      background-color: #f8f9fa;
      padding: 20px;
    }
    
    .logo {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    #digital-clock {
      font-size: 1.1rem;
      padding: 10px;
      background: #e9ecef;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    
    #teacher-info {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    
    #teacher-info img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
      border: 2px solid #ddd;
    }
    
    #signature-pad {
      border: 1px solid #000;
      background: #fff;
      width: 100%;
      height: 150px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    
    .video-container {
      position: relative;
      width: 100%;
      max-width: 100%;
      margin-top: 10px;
    }
    
    .video-container video,
    .video-container img {
      width: 100%;
      border-radius: 10px;
    }
    
    .camera-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
    }
    
    .btn-circle {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .time-warning {
      color: #dc3545;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card p-4">
          <div class="logo">
            <img src="https://example.com/school-logo.png" alt="โลโก้โรงเรียน" width="100">
            <h2 class="mt-2">โรงเรียนปากช่อง สพม. นครราชสีมา</h2>
          </div>

          <div id="digital-clock" class="mb-3"></div>

          <form id="checkin-form">
            <div class="mb-3">
              <label for="teacher-code" class="form-label">รหัสครูผู้สอน</label>
              <input type="text" class="form-control" id="teacher-code" placeholder="กรอกรหัสครู">
              <div id="teacher-info"></div>
            </div>

            <div class="mb-3">
              <label for="duty-type" class="form-label">ปฏิบัติหน้าที่</label>
              <select class="form-select" id="duty-type">
                <option value="เวรยืนประตู">เวรยืนประตู</option>
                <option value="ตรวจอาคาร">ตรวจอาคาร</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="location" class="form-label">ตำแหน่งปัจจุบัน</label>
              <input type="text" class="form-control" id="location" readonly>
            </div>

            <div class="mb-3">
              <label class="form-label">ลายมือชื่อ</label>
              <canvas id="signature-pad" class="form-control mb-2"></canvas>
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-outline-secondary btn-circle" onclick="clearSignature()">
                  <i class="fas fa-undo"></i>
                </button>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">ถ่ายภาพ</label>
              <div class="video-container position-relative">
                <video id="video" autoplay class="w-100" style="display: block;"></video>
                <div id="camera-overlay" class="camera-overlay d-none">
                  <i class="fas fa-camera camera-icon"></i>
                </div>
                <img id="captured-photo" class="w-100" style="display: none;">
              </div>
              <div class="d-flex justify-content-between mt-2">
                <button type="button" class="btn btn-primary" onclick="capturePhoto()">
                  <i class="fas fa-camera"></i> ถ่ายภาพ
                </button>
                <button type="button" class="btn btn-outline-secondary d-none" id="retake-btn" onclick="retakePhoto()">
                  <i class="fas fa-redo"></i> ถ่ายใหม่
                </button>
              </div>
            </div>

            <button id="checkin-btn" type="button" class="btn btn-success w-100 mt-3" onclick="submitForm()">
              <i class="fas fa-check"></i> เช็คอิน
            </button>
            <p id="time-warning" class="time-warning mt-2 text-center"></p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Font Awesome -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // แสดงนาฬิกาดิจิทัลแบบเรียลไทม์
    function updateDigitalClock() {
      const now = new Date();
      const days = ['อาทิตย์', 'จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์', 'เสาร์'];
      const months = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 
                     'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
      
      const dayName = days[now.getDay()];
      const date = now.getDate();
      const monthName = months[now.getMonth()];
      const year = now.getFullYear() + 543; // พ.ศ.
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      
      const thaiDate = `วัน${dayName}ที่ ${date} ${monthName} พ.ศ.${year} เวลา ${hours}:${minutes}:${seconds} น.`;
      document.getElementById('digital-clock').textContent = thaiDate;
    }

    // อัปเดตเวลาทุก 1 วินาที
    setInterval(updateDigitalClock, 1000);
    
    // ตรวจสอบเวลาเปิดใช้งานปุ่ม
    function checkTime() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const isEnabled = (hours === 7 && minutes >= 0 && minutes <= 59) || 
                        (hours === 8 && minutes === 0);
      
      const checkinBtn = document.getElementById('checkin-btn');
      const timeWarning = document.getElementById('time-warning');
      
      checkinBtn.disabled = !isEnabled;
      
      if (isEnabled) {
        timeWarning.textContent = '';
      } else {
        timeWarning.textContent = 'สามารถใช้งานได้ระหว่าง 07:00-08:00 น.';
      }
    }

    // ดึงข้อมูลครูจาก Google Sheet
    document.getElementById('teacher-code').addEventListener('input', function () {
      const code = this.value;
      if (code.length >= 3) {
        fetch('https://script.google.com/macros/s/AKfycbxt7UhN1kGeCvDLrOyW_1ggRx0p3OdmE4Y3YmigoZp-l7HLECxzZ38uyHNZHFSUO-96Og/exec' + '?teacherCode=' + code)
          .then(response => response.json())
          .then(data => {
            const infoDiv = document.getElementById('teacher-info');
            if (data.error) {
              infoDiv.innerHTML = '<p class="text-danger">ไม่พบข้อมูลครู</p>';
            } else {
              infoDiv.innerHTML = `
                <img src="${data.image}" alt="รูปครู">
                <div id="teacher-details">
                  <strong>${data.name}</strong>
                  <small class="d-block">${data.subject}</small>
                </div>
              `;
            }
          })
          .catch(error => {
            console.error('Error fetching teacher data:', error);
            const infoDiv = document.getElementById('teacher-info');
            infoDiv.innerHTML = '<p class="text-danger">เกิดข้อผิดพลาดในการดึงข้อมูลครู</p>';
          });
      }
    });

    // ลายมือชื่อ
    const canvas = document.getElementById("signature-pad");
    const signaturePad = new SignaturePad(canvas);

    function resizeCanvas() {
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
      signaturePad.clear(); // ลบลายมือชื่อเดิม
    }

    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // ฟังก์ชันรีเซ็ตลายเซ็น
    function clearSignature() {
      signaturePad.clear();
    }

    // ถ่ายภาพ
    const video = document.getElementById('video');
    const capturedPhoto = document.getElementById('captured-photo');
    const cameraOverlay = document.getElementById('camera-overlay');
    const retakeBtn = document.getElementById('retake-btn');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(err => {
        Swal.fire({
          icon: 'error',
          title: 'ไม่สามารถเข้าถึงกล้องได้',
          text: 'กรุณาอนุญาตการเข้าถึงกล้องก่อนใช้งาน',
          confirmButtonText: 'ตกลง'
        });
      });

    function capturePhoto() {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      capturedPhoto.src = canvas.toDataURL('image/png');
      
      // ซ่อนวิดีโอและแสดงรูปภาพที่ถ่าย
      video.style.display = 'none';
      capturedPhoto.style.display = 'block';
      cameraOverlay.classList.add('d-none');
      retakeBtn.classList.remove('d-none');
    }

    function retakePhoto() {
      capturedPhoto.style.display = 'none';
      video.style.display = 'block';
      retakeBtn.classList.add('d-none');
      
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
      
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
        });
    }

    // ส่งข้อมูล
    function submitForm() {
      const formData = new FormData();
      const now = new Date();
      const timestamp = now.toISOString();
      const teacherCode = document.getElementById('teacher-code').value;
      const dutyType = document.getElementById('duty-type').value;
      const location = document.getElementById('location').value;
      const teacherInfo = document.getElementById('teacher-details');
      const teacherName = teacherInfo ? teacherInfo.querySelector('strong')?.textContent || "ไม่พบข้อมูล" : "ไม่พบข้อมูล";

      // เพิ่มข้อมูลพื้นฐานลง FormData
      formData.append('timestamp', timestamp);
      formData.append('teacherCode', teacherCode);
      formData.append('dutyType', dutyType);
      formData.append('location', location);

      // เพิ่มลายมือชื่อ
      if (!signaturePad.isEmpty()) {
        formData.append('signature', signaturePad.toDataURL());
      }

      // เพิ่มรูปภาพ
      if (capturedPhoto.src && capturedPhoto.src !== 'data:,') {
        fetch(capturedPhoto.src)
          .then(res => res.blob())
          .then(blob => {
            formData.append('photo', blob, 'photo.png');

            // ส่งข้อมูลไปยัง Apps Script
            fetch('YOUR_WEB_APP_URL', {
              method: 'POST',
              body: formData
            })
              .then(response => {
                if (response.ok) {
                  // แสดง SweetAlert พร้อมข้อมูล
                  Swal.fire({
                    icon: 'success',
                    title: 'ส่งข้อมูลสำเร็จ!',
                    html: `
                      <div style="text-align:left; font-size:16px;">
                        <p><strong>วันที่และเวลา:</strong> ${now.toLocaleString('th-TH', { 
                          year: 'numeric', 
                          month: 'long', 
                          day: 'numeric', 
                          hour: '2-digit', 
                          minute: '2-digit', 
                          second: '2-digit'
                        })} น.</p>
                        <p><strong>ชื่อครู:</strong> ${teacherName}</p>
                        <p><strong>รหัสครู:</strong> ${teacherCode}</p>
                        <p><strong>ปฏิบัติหน้าที่:</strong> ${dutyType}</p>
                        <p><strong>ตำแหน่ง:</strong> ${location}</p>
                      </div>
                    `,
                    confirmButtonText: 'ปิด'
                  }).then(() => {
                    // รีเซ็ตหน้าหลังปิด
                    window.location.reload();
                  });
                }
              })
              .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                  icon: 'error',
                  title: 'เกิดข้อผิดพลาด',
                  text: 'ไม่สามารถส่งข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
                  confirmButtonText: 'ปิด'
                });
              });
          });
      } else {
        Swal.fire({
          icon: 'warning',
          title: 'กรุณาถ่ายภาพ',
          text: 'กรุณาถ่ายภาพก่อนส่งข้อมูล',
          confirmButtonText: 'ปิด'
        });
      }
    }

    // เรียกใช้ฟังก์ชันเริ่มต้น
    updateDigitalClock();
    checkTime();
    setInterval(checkTime, 60000); // ตรวจสอบทุก 1 นาที
  </script>
</body>
</html>
